<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enerzo  — Demo Đặt chỗ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
:root { --brand:#26cdeb; --accent:#127dab; }
body { font-family:Inter, sans-serif; margin:0; background:#f3f4f6; color:#0f172a; }
header { background:linear-gradient(90deg,var(--brand),#166534); color:#fff; padding:14px 16px; display:flex; align-items:center; gap:12px; box-shadow:0 2px 6px rgba(2,6,23,0.08); }
header .title { font-size:18px; font-weight:700; }
main { padding:14px; padding-bottom:84px; }
#map { height:360px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.08); overflow:hidden; }
.controls { display:flex; gap:8px; align-items:center; margin-top:10px; }
.btn { background:var(--brand); color:#fff; padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
.btn.ghost { background:#fff; color:var(--brand); border:1px solid #e2e8f0; }
.panel { background:#fff; padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.04); margin-top:12px; }
.station-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; border:1px solid #e6eef6; margin-bottom:8px; }
.station-meta { font-size:13px; color:#334155; }
footer.nav { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e6eef6; display:flex; justify-content:space-around; padding:10px 0; box-shadow:0 -4px 18px rgba(2,6,23,0.04); }
footer.nav button { background:none; border:none; color:var(--brand); font-weight:700; cursor:pointer; }
footer.nav button.active { color:#0f172a; }
.section { display:none; }
.section.active { display:block; }
.small { font-size:13px; color:#475569; }
.badge { background:var(--accent); color:#fff; padding:6px 8px; border-radius:8px; font-weight:700; }
.empty { color:#64748b; text-align:center; padding:18px; }
.booking-item { border:1px solid #eef2ff; padding:10px; border-radius:10px; margin-bottom:8px; background:#fff; display:flex; justify-content:space-between; align-items:center; }

/* Modal login */
#login-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
#login-modal .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 300px; box-shadow:0 6px 18px rgba(2,6,23,0.2); display: flex; flex-direction: column; gap: 12px; }
#login-modal input { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
#login-modal button { padding: 10px 12px; border-radius: 8px; border: none; background: var(--brand); color: #fff; font-weight: 600; cursor: pointer; }
#login-modal .close-btn { background: #f87171; }
</style>
</head>
<body>
<header>
<div class="title">🔌 Enerzo — Demo Đặt chỗ</div>
<div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
<div class="small" style="color:rgba(255,255,255,0.9)">⭐ <span id="points-badge">0</span> điểm</div>
<button id="login-btn" class="btn ghost">Đăng nhập</button>
<button id="logout-btn" class="btn ghost" style="display:none;">Đăng xuất</button>
</div>
</header>
<main>
<section id="home" class="section active">
<div id="map"></div>
<div class="controls">
<button class="btn" id="locate-btn">📍 Quét vị trí</button>
<button class="btn ghost" id="refresh-markers">↻ Cập nhật trạm</button>
</div>
<div class="panel">
<h3 style="margin:0 0 8px 0">Trạm sạc gần bạn</h3>
<div id="stations-list"></div>
</div>
</section>
<section id="bookings" class="section">
<div class="panel">
<h3>📅 Đặt chỗ của tôi</h3>
<div id="bookings-list"></div>
</div>
</section>
<section id="promo" class="section">
<div class="panel">
<h3>🎁 Khuyến mãi</h3>
<div id="promo-list">Hiện chưa có khuyến mãi nào</div>
</div>
</section>
<section id="points" class="section">
<div class="panel">
<h3>⭐ Tích điểm</h3>
<p class="small">Điểm hiện có được lưu trên thiết bị (localStorage). Bạn nhận điểm khi đặt chỗ.</p>
<div style="margin-top:8px"><span class="badge" id="points-big">0</span></div>
</div>
</section>
<section id="profile" class="section">
<div class="panel">
<h3>👤 Cá nhân</h3>
<p class="small">Tên: <b id="user-name">Khách vãng lai</b></p>
<p class="small">Email: <span id="user-email">Chưa đăng nhập</span></p>
</div>
</section>
</main>
<footer class="nav">
<button data-target="home" class="active">🏠 Trang chủ</button>
<button data-target="bookings">📅 Đặt chỗ</button>
<button data-target="promo">🎁 Khuyến mãi</button>
<button data-target="points">⭐ Tích điểm</button>
<button data-target="profile">👤 Cá nhân</button>
</footer>

<!-- Modal Login -->
<div id="login-modal">
  <div class="modal-content">
    <h3>Đăng nhập ChargeGo</h3>
    <input type="text" id="login-name" placeholder="Tên của bạn">
    <input type="email" id="login-email" placeholder="Email">
    <button id="submit-login">Đăng nhập</button>
    <button id="close-login" class="close-btn">Đóng</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let stations=[
{id:1,name:'VinFast - Thủ Đức',lat:10.8546,lon:106.7840,slots:4,price:15},
{id:2,name:'EVN Station - Q9',lat:10.8375,lon:106.7768,slots:2,price:12},
{id:3,name:'Điện Quang - Bình Thạnh',lat:10.8038,lon:106.7183,slots:6,price:10},
{id:4,name:'ChargeHub - Linh Trung',lat:10.8721,lon:106.7832,slots:3,price:18}
];
let bookings=JSON.parse(localStorage.getItem('cg_bookings')||'[]');
let points=parseInt(localStorage.getItem('cg_points')||'0',10);
let currentUser=JSON.parse(localStorage.getItem('cg_user')||'null');

const loginBtn=document.getElementById('login-btn');
const logoutBtn=document.getElementById('logout-btn');

function updateUI(){
  document.getElementById('points-badge').textContent=points;
  document.getElementById('points-big').textContent=points;
  if(currentUser){
    document.getElementById('user-name').textContent=currentUser.name;
    document.getElementById('user-email').textContent=currentUser.email;
    loginBtn.style.display='none'; logoutBtn.style.display='inline-block';
  } else {
    document.getElementById('user-name').textContent='Khách vãng lai';
    document.getElementById('user-email').textContent='Chưa đăng nhập';
    loginBtn.style.display='inline-block'; logoutBtn.style.display='none';
  }
}
updateUI();

// Modal login
loginBtn.addEventListener('click',()=>{ document.getElementById('login-modal').style.display='flex'; });
document.getElementById('close-login').addEventListener('click',()=>{ document.getElementById('login-modal').style.display='none'; });
document.getElementById('submit-login').addEventListener('click',()=>{
  const name=document.getElementById('login-name').value.trim();
  const email=document.getElementById('login-email').value.trim();
  if(name && email){
    currentUser={name,email};
    localStorage.setItem('cg_user',JSON.stringify(currentUser));
    updateUI();
    document.getElementById('login-modal').style.display='none';
    alert('Đăng nhập thành công!');
  } else alert('Vui lòng nhập đủ tên và email!');
});

logoutBtn.addEventListener('click',()=>{
  currentUser=null;
  localStorage.removeItem('cg_user');
  updateUI();
  alert('Đã đăng xuất!');
});

const map=L.map('map').setView([10.8546,106.7840],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);

// ===== Đặt + hủy + thời gian hết hạn =====
window.bookFromMap = function(id){
  if(!currentUser){alert('Vui lòng đăng nhập!'); return;}
  const st=stations.find(s=>s.id===id);
  if(st.slots<=0){alert('Hết chỗ trống!'); return;}
  st.slots--;

  const expireTime = Date.now() + 30*60*1000; // 30 phút
  bookings.push({
    id: Date.now(),
    station: st.name,
    price: st.price,
    date: new Date().toLocaleString(),
    expire: expireTime
  });

  points+=5;
  localStorage.setItem('cg_bookings',JSON.stringify(bookings));
  localStorage.setItem('cg_points',points);
  updateUI(); renderBookings(); renderStations();
  alert(`Đặt chỗ tại ${st.name} thành công! +5 điểm`);
}

function cancelBooking(id){
  const idx=bookings.findIndex(b=>b.id===id);
  if(idx!==-1){
    const st=stations.find(s=>s.name===bookings[idx].station);
    if(st) st.slots++;
    bookings.splice(idx,1);
    localStorage.setItem('cg_bookings',JSON.stringify(bookings));
    renderBookings(); renderStations();
    alert("Đã hủy đặt chỗ!");
  }
}

function cleanExpiredBookings(){
  const now=Date.now();
  let changed=false;
  bookings=bookings.filter(b=>{
    if(b.expire && now>b.expire){
      const st=stations.find(s=>s.name===b.station);
      if(st) st.slots++;
      changed=true;
      return false;
    }
    return true;
  });
  if(changed){
    localStorage.setItem('cg_bookings',JSON.stringify(bookings));
    renderBookings(); renderStations();
  }
}
setInterval(cleanExpiredBookings,60000);

// Render bookings
function renderBookings(){
  const list=document.getElementById('bookings-list');
  list.innerHTML='';
  if(bookings.length===0){list.innerHTML='<div class="empty">Chưa có đặt chỗ nào</div>'; return;}
  bookings.forEach(b=>{
    const remain = Math.max(0, Math.floor((b.expire-Date.now())/60000));
    const item=document.createElement('div');
    item.className='booking-item';
    item.innerHTML=`
      <div>
        <b>${b.station}</b><br>
        <span class="small">${b.date} — còn ${remain} phút</span>
      </div>
      <button class="btn ghost">Hủy</button>
    `;
    item.querySelector('button').addEventListener('click',()=>cancelBooking(b.id));
    list.appendChild(item);
  });
}

// ===== Hiển thị trạm trong bán kính 1km =====
function distanceKm(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function renderStationsNearby(lat,lon){
  document.getElementById('stations-list').innerHTML='';
  map.eachLayer(l=>{if(l instanceof L.Marker && !l._isTile) map.removeLayer(l);});

  stations.forEach(st=>{
    if(distanceKm(lat,lon,st.lat,st.lon)<=1){
      const item=document.createElement('div');
      item.className='station-item';
      item.innerHTML=`<div><b>${st.name}</b><br><span class='station-meta'>${st.slots} chỗ trống — ${st.price}k VND</span></div><button class='btn'>Đặt</button>`;
      item.querySelector('button').addEventListener('click',()=>bookFromMap(st.id));
      document.getElementById('stations-list').appendChild(item);

      const marker=L.marker([st.lat,st.lon]).addTo(map);
      marker.bindPopup(`<b>${st.name}</b><br>${st.slots} chỗ trống — ${st.price}k VND<br><button class='btn' onclick='bookFromMap(${st.id})'>Đặt chỗ</button>`);
    }
  });
}

function renderStations(){
  document.getElementById('stations-list').innerHTML='';
  map.eachLayer(l=>{if(l instanceof L.Marker && !l._isTile) map.removeLayer(l);});
  stations.forEach(st=>{
    const item=document.createElement('div');
    item.className='station-item';
    item.innerHTML=`<div><b>${st.name}</b><br><span class='station-meta'>${st.slots} chỗ trống — ${st.price}k VND</span></div><button class='btn'>Đặt</button>`;
    item.querySelector('button').addEventListener('click',()=>bookFromMap(st.id));
    document.getElementById('stations-list').appendChild(item);

    const marker=L.marker([st.lat,st.lon]).addTo(map);
    marker.bindPopup(`<b>${st.name}</b><br>${st.slots} chỗ trống — ${st.price}k VND<br><button class='btn' onclick='bookFromMap(${st.id})'>Đặt chỗ</button>`);
  });
}

renderStations(); renderBookings();

document.getElementById('locate-btn').addEventListener('click',()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude}=pos.coords;
      map.setView([latitude,longitude],15);
      L.circle([latitude,longitude],{radius:50,color:'blue'}).addTo(map).bindPopup('Bạn đang ở đây').openPopup();
      renderStationsNearby(latitude,longitude);
    });
  } else alert('Trình duyệt không hỗ trợ định vị!');
});
document.getElementById('refresh-markers').addEventListener('click',renderStations);

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

// ===== Điều hướng bằng URL hash =====
function showSection(sectionId){
  document.querySelectorAll('footer.nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  document.querySelector(`footer.nav button[data-target="${sectionId}"]`)?.classList.add('active');
}

// Khi click menu -> đổi hash
document.querySelectorAll('footer.nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    window.location.hash = btn.dataset.target; // cập nhật URL
    showSection(btn.dataset.target);
  });
});

// Khi load lại trang -> đọc hash để mở đúng section
window.addEventListener('load',()=>{
  const hash = window.location.hash.replace('#','');
  if(hash){
    showSection(hash);
  }
});

</script>
</body>
</html>


